{% extends "base.html" %}

{% block title %}MLM - Torrents{% endblock %}

{% block head %}
  <style>
    .TorrentsTable {
      display: none;
    }
  </style>
{% endblock %}

{% block content %}
<form class="row">
  <h1>Torrents</h1>
  <label>
    <input type="submit" style="display:none">
    Search: <input type=text value="{{ query }}" name=query>
    <button is="clear-button" type="button"></button>
  </label>
  <div class="table_options">
    <div class="option_group query">
      Columns:
      <div>
      <label>
        Category
        <input type=checkbox name=show {% if show.category %}checked{% endif %} value="category">
      </label>
      <label>
        Categories
        <input type=checkbox name=show {% if show.categories %}checked{% endif %} value="categories">
      </label>
      <label>
        Flags
        <input type=checkbox name=show {% if show.flags %}checked{% endif %} value="flags">
      </label>
      <label>
        Edition
        <input type=checkbox name=show {% if show.edition %}checked{% endif %} value="edition">
      </label>
      <label>
        Authors
        <input type=checkbox name=show {% if show.authors %}checked{% endif %} value="author">
      </label>
      <label>
        Narrators
        <input type=checkbox name=show {% if show.narrators %}checked{% endif %} value="narrator">
      </label>
      <label>
        Series
        <input type=checkbox name=show {% if show.series %}checked{% endif %} value="series">
      </label>
      <label>
        Language
        <input type=checkbox name=show {% if show.language %}checked{% endif %} value="language">
      </label>
      <label>
        Size
        <input type=checkbox name=show {% if show.size %}checked{% endif %} value="size">
      </label>
      <label>
        Filetypes
        <input type=checkbox name=show {% if show.filetypes %}checked{% endif %} value="filetype">
      </label>
      <label>
        Linker
        <input type=checkbox name=show {% if show.linker %}checked{% endif %} value="linker">
      </label>
      <label>
        Category
        <input type=checkbox name=show {% if show.qbit_category %}checked{% endif %} value="qbit_category">
      </label>
      <label>
        Path
        <input type=checkbox name=show {% if show.path %}checked{% endif %} value="path">
      </label>
      <label>
        Added At
        <input type=checkbox name=show {% if show.created_at %}checked{% endif %} value="created_at">
      </label>
      <label>
        Uploaded At
        <input type=checkbox name=show {% if show.uploaded_at %}checked{% endif %} value="uploaded_at">
      </label>
      </div>
    </div>
    <div class="option_group query">
      Page size: {{ paging.selector([100, 500, 1000, 5000]) | safe }}
    </div>
  </div>
</form>
<form method=post>
<div class="actions actions_torrent">
  <button name=action value=refresh>refresh metadata</button>
  <button name=action value=refresh-relink>refresh metadata and relink</button>
  <button name=action value=clean data-prompt="Are you sure you want to clean the selected torrents?">clean torrent</button>
  <button name=action value=remove data-prompt="Are you sure you want to remove the selected torrents?">remove torrent from MLM</button>
</div>
<div class="TorrentsTable table2">
<div>
  {{ table_header_all("torrent", 30) | safe }}
  {% if show.category %}
  {{ table_header_s(Some(TorrentsPageSort::Kind), "Type", 130) }}
  {% else %}
  {{ table_header_s(Some(TorrentsPageSort::Kind), "Type", 89) }}
  {% endif %}
  {{ table_header_if(show.categories, None, "Categories", Flex(1, 130)) }}
  {{ table_header_if(show.flags, None, "Flags", 60) }}
  {{ table_header_s(Some(TorrentsPageSort::Title), "Title", Flex(2, 170)) }}
  {{ table_header_if(show.edition, Some(TorrentsPageSort::Edition), "Edition", 80) }}
  {{ table_header_if(show.authors, Some(TorrentsPageSort::Authors), "Authors", Flex(1, 130)) }}
  {{ table_header_if(show.narrators, Some(TorrentsPageSort::Narrators), "Narrators", Flex(1, 130)) }}
  {{ table_header_if(show.series, Some(TorrentsPageSort::Series), "Series", Flex(1, 130)) }}
  {{ table_header_if(show.language, Some(TorrentsPageSort::Language), "Language", 100) }}
  {{ table_header_if(show.size, Some(TorrentsPageSort::Size), "Size", 81) }}
  {{ table_header_if(show.filetypes, None, "Filetypes", 100) }}
  {{ table_header_if(show.linker, Some(TorrentsPageSort::Linker), "Linker", 130) }}
  {{ table_header_if(show.qbit_category, Some(TorrentsPageSort::QbitCategory), "Qbit Category", 100) }}
  {{ table_header_if(!show.path, Some(TorrentsPageSort::Linked), "Linked", 72) }}
  {{ table_header_if(show.path, Some(TorrentsPageSort::Linked), "Path", Flex(2, 200)) }}
  {{ table_header_if(show.created_at, Some(TorrentsPageSort::CreatedAt), "Added At", 157) }}
  {{ table_header_if(show.uploaded_at, Some(TorrentsPageSort::UploadedAt), "Uploaded At", 157) }}
  {{ table_header_s(None, "", 132) }}
</div>
{% for torrent in torrents %}
<div>
  <div><input type=checkbox name=torrent value={{torrent.id}}></div>
  <div>
    <span title="{{ torrent.meta.cat_name() }}">{{ item(TorrentsPageFilter::Kind, torrent.meta.media_type.as_str()) }}</span>
    {% if show.category %}
    {% if let Some(cat) = torrent.meta.cat %}
    <div>{{ item_v(TorrentsPageFilter::Category, torrent.meta.cat_name(), &cat.as_id().to_string()) }}</div>
    {% endif %}
    {% endif %}
  </div>
  {% if show.categories %}
  <div>{{ cats(TorrentsPageFilter::Categories, torrent.meta.categories) }}</div>
  {% endif %}
  {% if show.flags %}
  <div>{{ torrent.meta.flag_icons() }}</div>
  {% endif %}
  <div>
    {{ item(TorrentsPageFilter::Title, torrent.meta.title) }}
    {% match torrent.client_status %}
    {% when Some(ClientStatus::RemovedFromMam) %}
      <span class=warn title="Torrent is removed from MaM but still seeding">
        {{ item_v(TorrentsPageFilter::ClientStatus, "⚠", "removed_from_mam") }}
      </span>
    {% when Some(ClientStatus::NotInClient) %}
      <span class=warn title="Torrent is not seeding">
        {{ item_v(TorrentsPageFilter::ClientStatus, "ℹ", "not_in_client") }}
      </span>
    {% when None %}
    {% endmatch %}
  </div>
  {% if show.edition %}
   <div>{% if let Some((edition, _)) = torrent.meta.edition %}{{ edition }}{% endif %}</div>
  {% endif %}
  {% if show.authors %}
  <div>{{ items(TorrentsPageFilter::Author, torrent.meta.authors) }}</div>
  {% endif %}
  {% if show.narrators %}
  <div>{{ items(TorrentsPageFilter::Narrator, torrent.meta.narrators) }}</div>
  {% endif %}
  {% if show.series %}
  <div>{{ series(TorrentsPageFilter::Series, torrent.meta.series) }}</div>
  {% endif %}
  {% if show.language %}
  <div>{{ item(TorrentsPageFilter::Language, torrent.meta.language.map(Language::to_str).unwrap_or_default()) }}</div>
  {% endif %}
  {% if show.size %}
  <div>{{ torrent.meta.size }}</div>
  {% endif %}
  {% if show.filetypes %}
  <div>{{ items(TorrentsPageFilter::Filetype, torrent.meta.filetypes) }}</div>
  {% endif %}
  {% if show.linker %}
  <div>{{ item(TorrentsPageFilter::Linker, &torrent.linker.clone().unwrap_or_default()) }}</div>
  {% endif %}
  {% if show.qbit_category %}
  <div>{{ item(TorrentsPageFilter::QbitCategory, &torrent.category.clone().unwrap_or_default()) }}</div>
  {% endif %}
  {% if show.path %}
  <div>
    {% match torrent.library_path %}
    {% when Some(path) %}
      {{ path.to_string_lossy() }}
    {% when None %}
    {% endmatch %}
    {% match torrent.library_mismatch %}
    {% when Some(LibraryMismatch::NewLibraryDir(path)) %}
      <span class=warn title="Wanted library dir: {{ path.to_string_lossy() }}">
        {{ item_v(TorrentsPageFilter::LibraryMismatch, "⚠", "new_library") }}
      </span>
    {% when Some(LibraryMismatch::NewPath(path)) %}
      <span class=warn title="Wanted library path: {{ path.to_string_lossy() }}">
        {{ item_v(TorrentsPageFilter::LibraryMismatch, "⚠", "new_path") }}
      </span>
    {% when Some(LibraryMismatch::NoLibrary) %}
      <span class=warn title="No longer wanted in library">{{ item_v(TorrentsPageFilter::LibraryMismatch, "⚠", "no_library") }}</span>
    {% when None %}
    {% endmatch %}
  </div>
  {% else %}
    <div {% if let Some(path) = torrent.library_path %}title="{{ path.to_string_lossy() }}"{% endif %}>
      {{ item(TorrentsPageFilter::Linked, &torrent.library_path.is_some().to_string()) }}
      {% match torrent.library_mismatch %}
      {% when Some(LibraryMismatch::NewLibraryDir(path)) %}
        <span class=warn title="Wanted library dir: {{ path.to_string_lossy() }}">
          {{ item_v(TorrentsPageFilter::LibraryMismatch, "⚠", "new_library") }}
        </span>
      {% when Some(LibraryMismatch::NewPath(path)) %}
        <span class=warn title="Wanted library path: {{ path.to_string_lossy() }}">
          {{ item_v(TorrentsPageFilter::LibraryMismatch, "⚠", "new_path") }}
        </span>
      {% when Some(LibraryMismatch::NoLibrary) %}
        <span class=warn title="No longer wanted in library">{{ item_v(TorrentsPageFilter::LibraryMismatch, "⚠", "no_library") }}</span>
      {% when None %}
      {% endmatch %}
    </div>
  {% endif %}
  {% if show.created_at %}
  <div>{{ self::time(torrent.created_at) }}</div>
  {% endif %}
  {% if show.uploaded_at %}
  <div>{{ self::time(torrent.meta.uploaded_at) }}</div>
  {% endif %}
  <div>
    <a href="/torrents/{{torrent.id}}">open</a>
    <a href="https://www.myanonamouse.net/t/{{ torrent.meta.mam_id }}" target=_blank>MaM</a>
    {% if let (Some(abs_url), Some(abs_id)) = (abs_url.as_ref(), torrent.abs_id.as_ref()) %}
      <a href="{{ abs_url }}/audiobookshelf/item/{{ abs_id }}" target=_blank>ABS</a>
    {% endif %}
  </div>
</div>
{% endfor %}
</div>
{% if torrents.is_empty() %}
<p><i>You have no torrents selected by MLM</i>
{% endif %}
</form>
{{ paging | safe }}
<style>
  .TorrentsTable {
    display: block;
    {{table2_styles() | safe}}
  }
</style>
{% endblock %}
